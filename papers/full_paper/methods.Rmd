---
title: "MCC Paper MEthods"
author: "Manuel Bohn"
output: 
  html_document:
  toc: true
  toc_float: true
  
---

```{r setup, include=FALSE}

# load packages and functions
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(knitr)
library(ggthemes)
library(langcog)
library(rwebppl)
library(matrixStats)
library(coda)
library(ggpubr)

estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}

hdi_upper<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}

hdi_lower<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}

```


```{r}
# preparing datafiles (delete eventually)

# d <- read_csv(file="../../stats/data/inf.data.csv") %>%
#   mutate(trial_type = ifelse(trial == "train", "train", "test"),
#          trial = alltrial -2,
#          experiment = "adult_ex1",
#          condition = ifelse(control == TRUE, "control", "test") )%>%
#   filter(trial_type == "test")%>%
#   select(experiment, id,  trial,condition, agent, correct)
# 
# write_csv(d , path="../../stats/data/adult_ex1.csv")
# 
# d <- read_csv(file="../../stats/data/novel.data.csv") %>%
#   mutate(trial_type = ifelse(trial == "train", "train", "test"),
#          experiment = "adult_ex2_novelty",
#          speaker = ifelse(change == TRUE, "different_speaker" , "same_speaker"),
#          agent = ifelse( condition == "same_speaker", agent, altAgent))%>%
#   filter(trial != "train")%>%
#   select(experiment, id, trial,speaker, agent, correct)
# 
# write_csv(d , path="../../stats/data/adult_ex2_novelty.csv")
# 
# d <- read_csv(file="../../stats/data/pref.data.csv") %>%
#   mutate(trial_type = ifelse(trial == "train", "train", "test"),
#          experiment = "adult_ex2_preference",
#          speaker = ifelse(change == TRUE, "different_speaker" , "same_speaker"),
#          agent = ifelse( condition == "same_speaker", agent, altAgent))%>%
#   filter(trial != "train")%>%
#   select(experiment, id, trial,speaker, agent, correct)
# 
# write_csv(d , path="../../stats/data/adult_ex2_preference.csv")
# 
# d <- bind_rows(read_csv(file="../../stats/data/ex3.novel.data.csv"),
#                read_csv(file="../../stats/data/ex3.pref.data.csv")) %>%
#   mutate(trial_type = ifelse(trial == "train1" | trial =="train2", "train", "test"),
#          agent = ifelse( change == "same", agent, altAgent),
#          common_ground_manipulation = ifelse(experiment == "novel_inf","novelty", "preference"),
#          experiment = "adult_ex3",
#          trial = alltrial -2,
#          speaker = ifelse(change == "same", "same_speaker", "different_speaker"))%>%
#   filter(trial_type == "test")%>%
#   select(experiment, id,trial, common_ground_manipulation, speaker ,alignment, agent, correct_inf)
# 
# write_csv(d , path="../../stats/data/adult_ex3.csv")
# 
# 
# d <- bind_rows(read_csv(file="../../stats/data/ex3.2.novel.strong.data.csv"),
#                read_csv(file="../../stats/data/ex3.2.novel.medium.data.csv"),
#                read_csv(file="../../stats/data/ex3.2.novel.weak.data.csv"),
#                read_csv(file="../../stats/data/ex3.2.pref.strong.data.csv"),
#                read_csv(file="../../stats/data/ex3.2.pref.medium.data.csv")
#                ) %>%
#   mutate(trial_type = ifelse(trial == "train1" | trial =="train2", "train", "test"),
#          agent = ifelse( change == "same", agent, altAgent),
#          common_ground_manipulation = ifelse(grepl("novel",experiment),"novelty", "preference"),
#          trial = alltrial -2,
#          speaker = ifelse(change == "same", "same_speaker", "different_speaker"),
#          prior_manipulation = prior,
#          experiment = "adult_ex4")%>%
#   filter(trial_type == "test")%>%
#   select(experiment, id,trial, common_ground_manipulation, prior_manipulation, speaker, alignment, agent, correct_inf)
# 
# write_csv(d , path="../../stats/data/adult_ex4.csv")
#
# 
# d <- bind_rows(read_csv(file="../../stats/data/kids_pref_data.csv")%>%filter(age != "2")%>%mutate(speakerChange = change),
#                        read_csv(file="../../stats/data/kids_pref_2_data.csv"))%>%
#   filter(trial != "train")%>%
#   mutate(age_bin = factor(age),
#          experiment = "child_ex2",
#          condition = ifelse(speakerChange == F, "same_speaker", "different_speaker"),
#          agent = ifelse( speakerChange == F, agent, altAgent),
#          id = subid,
#          minage = min(age_num))%>%
#   filter(trial != "train")%>%
#   select(experiment,id,age_bin,age_num,minage,trial,condition,agent,correct)
# 
# write_csv(d , path="../../stats/data/child_ex2.csv")
# 
# d <- bind_rows(
#   read_csv(file="../../stats/data/kids_inf_data.csv"),
#   read_csv(file="../../stats/data/kids_inf_2_data.csv"))%>%
#   filter(subage != "2",
#          trial != "filler1",
#          trial != "filler2")%>%
#   mutate(age_bin = factor(subage),
#          experiment = "child_ex1",
#          id =subid,
#          minage = min(age_num))%>%
#   select(experiment,id,age_bin,age_num,minage,trial,correct)
# 
# write_csv(d , path="../../stats/data/child_ex1.csv")
# 
# 
# d <- read_csv(file="../../stats/data/kids_ex3_data.csv")%>%
#   mutate(experiment = "child_ex3",
#          id = subid,
#          age_bin = subage,
#          speaker = Speaker,
#          alignment = Alignment,
#          minage = min(age_num))%>%
#   filter(trial != "filler1",trial != "filler2")%>%
#   select(experiment, id,age_bin,age_num,minage,trial, speaker, alignment, agent, correct_inf)
# 
#  write_csv(d , path="../../stats/data/child_ex3.csv")


```


```{r data, include= FALSE}
# load data files

# adults exp 1 
adult_ex1_data <- read_csv(file="../../stats/data/adult_ex1.csv")
# adults exp 2 novelty
adult_ex2_novelty_data <- read_csv(file="../../stats/data/adult_ex2_novelty.csv")
# adults exp 2 preference
adult_ex2_preference_data <- read_csv(file="../../stats/data/adult_ex2_preference.csv")
# adults ex3
adult_ex3_data <-read_csv(file="../../stats/data/adult_ex3.csv") 
# adults ex4
adult_ex4_data <-read_csv(file="../../stats/data/adult_ex4.csv") 

# children ex1
child_ex1_data <-read_csv(file="../../stats/data/child_ex1.csv")
# children ex2 preference
child_ex2_data <-read_csv(file="../../stats/data/child_ex2.csv") 
# children ex3
child_ex3_data <-read_csv(file="../../stats/data/child_ex3.csv") 

```

# Adults 

## Seperate assessment of general and speaker specific expectations (Exp. 1 and 2).

```{r, figure 1}
p_fig1 <- bind_rows(adult_ex1_data,
                    adult_ex2_novelty_data %>%
                      mutate(condition = ifelse(condition == "same_speaker","test", "control")),
                    adult_ex2_preference_data%>% 
                      mutate(condition = ifelse(condition == "same_speaker","test", "control"))) %>%
  mutate(experiment = factor(experiment),
         condition = factor(condition, levels = c("test","control")))%>%
  group_by(experiment,condition , id) %>%
  summarise(correct = mean(correct))

p_fig1x <- p_fig1 %>%
  multi_boot_standard(col = "correct")


ggplot() +
  geom_jitter(data = p_fig1, aes(x = condition, y = correct, col = condition), alpha = 0.3, width = .3,height = .02)+
  geom_pointrange(data = p_fig1x, aes(x = condition, y = mean, col = condition,ymin = ci_lower, ymax = ci_upper),size = .8, pch = 5, fatten = 2.5)+
  geom_hline(yintercept = 0.5, lty=2)+
  labs(x="",y="Proportion Correct")+
  facet_wrap( ~ experiment, labeller = as_labeller(c(`adult_ex2_preference`="Exp. 2 - Pref.", `adult_ex2_novelty`="Exp. 2 - Nov.", `adult_ex1`="Exp. 1 - Info.")))+
  theme_few() + 
  ylim(-0.05,1.05)+
  guides(alpha = F,size =F)+
  scale_color_solarized(name = "Condition",
                     breaks=c("test","control"))+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


```

## Model predictions for information integration evaluated against new data (Exp 3). 

```{r figure adults}

adult_ex3_plot_data <- adult_ex3_data%>%
  group_by(common_ground_manipulation,speaker,alignment,id)%>%
  summarise(mean = mean(correct_inf))%>%
  mutate(model = "data")

adult_ex3_pred <- readRDS( "../../stats/saves/adult_ex3_model_predictions_data.rds")%>%
  filter(model != "flat_prior",
         model != "prior_only")%>%
  mutate(prior_manipulation = "strong",
        experiment = "experiment 3")


adult_ex4_pred <- readRDS( "../../stats/saves/adult_ex4_model_predictions_data.rds")%>%
  filter(model != "flat_prior",
         model != "prior_only")%>%
  mutate(experiment = "experiment 4")


ggplot(data = adult_ex3_pred, aes(x = alignment, y = mean, col = model)) +
  geom_jitter(data = adult_ex3_plot_data, alpha = .1, height = 0.02)+
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), size = .6,  position = position_dodge(width = .5), pch = 5)+
  geom_hline(yintercept = 0.5, lty=2)+
  labs(x="",y="Choosing more informative")+
  facet_grid (~ common_ground_manipulation + speaker) +
  theme_few() + 
  ylim(-0.05,1.05)+
  guides(alpha = F)+ 
  scale_color_manual(name="Model",
                     breaks=c("data","pragmatic","flat_prior","prior_only"),
                     values= c("black","#859900","#6c71c4","#b58900"))+
  theme(axis.text.x=element_text(angle = 45, vjust = 1, hjust = 1))

```

## Replication and extension to varying levels of prior manipulation (Exp 4).

```{r}

adult_ex3_cor_plot <- adult_ex3_pred %>%
  ungroup()%>%
  filter(model != "data") %>%
  mutate(data_mean = rep(adult_ex3_pred%>%filter(model == "data")%>%pull(mean),1),
         data_ci_lower = rep(adult_ex3_pred%>%filter(model == "data")%>%pull(ci_lower),1),
         data_ci_upper = rep(adult_ex3_pred%>%filter(model == "data")%>%pull(ci_upper),1))
  

adult_ex4_cor_plot <- adult_ex4_pred %>%
  ungroup()%>%
  filter(model != "data") %>%
  mutate(data_mean = rep(adult_ex4_pred%>%filter(model == "data")%>%pull(mean),1),
         data_ci_lower = rep(adult_ex4_pred%>%filter(model == "data")%>%pull(ci_lower),1),
         data_ci_upper = rep(adult_ex4_pred%>%filter(model == "data")%>%pull(ci_upper),1))

adult_rep_cor_plot <- adult_ex4_pred %>%
  ungroup()%>%
  filter(model == "data",
         prior_manipulation == "strong") %>%
  mutate(data_mean = rep(adult_ex3_pred%>%filter(model == "data")%>%pull(mean),1),
         data_ci_lower = rep(adult_ex3_pred%>%filter(model == "data")%>%pull(ci_lower),1),
         data_ci_upper = rep(adult_ex3_pred%>%filter(model == "data")%>%pull(ci_upper),1),
         experiment = "replication")
  
adult_pred <- bind_rows(adult_ex3_cor_plot,
                        adult_ex4_cor_plot,
                        adult_rep_cor_plot)%>%
  mutate(prior_manipulation = relevel(as.factor(prior_manipulation), ref = "strong"),
         experiment = factor(experiment,levels = c("experiment 3", "replication", "experiment 4")))

ggplot(data = adult_pred,aes(x = mean, y = data_mean, col = prior_manipulation)) +
  geom_abline(intercept = 0, slope = 1, lty = 2, alpha = 0.7, size = 0.5)+
  geom_point(size = 2)+
  geom_errorbar(aes(ymin = data_ci_lower, ymax = data_ci_upper),width = 0,size = .7)+
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0,size = .7)+
  coord_fixed()+
  xlim(0,1)+ylim(0,1)+
  xlab("")+
  ylab("")+
  facet_grid ( ~ experiment) +
  stat_cor(method = "pearson", label.x = 0.01, label.y = 0.99, aes(x = mean, y = data_mean), inherit.aes = F, size = 3)+
  theme_few() + 
  scale_colour_ptol(name = "Prior manipulation")

```


# Children

## Seperate assessment of general and speaker specific expectations.

## Model predictions for information integration evaluated against new data. 


```{r, figure x}

plot_child_ex12 <- bind_rows(child_ex1_data%>%
                      mutate(condition = "test"),
                    child_ex2_data %>%
                      mutate(condition = ifelse(condition == "same_speaker","test", "control"))) %>%
  mutate(experiment = factor(experiment),
         condition = factor(condition, levels = c("test","control")))%>%
  group_by(experiment,condition,age_num, id) %>%
  summarise(correct = mean(correct))


ggplot(data = plot_child_ex12, aes(x = age_num, y = correct, col = condition)) +
  geom_hline(yintercept = 0.5, lty=2)+
  geom_jitter(alpha = 0.2, height = 0.02, width = 0)+
  geom_smooth(aes(fill = condition),method = "lm", se = T, alpha = .5, size = .7)+
  labs(x="Age",y="Proportion Correct")+
  facet_wrap( ~ experiment, labeller = as_labeller(c(`child_ex2`="Exp. 2 - Pref.", `child_ex1`="Exp. 1 - Info.")))+
  theme_few() +
  ylim(-0.05,1.05)+
  guides(alpha = F)+ 
  scale_color_solarized(name = "Condition")+
  scale_fill_solarized(name = "Condition")

```

```{r}
child_model_predictions <- readRDS(  "../../stats/saves/child_ex3_model_predictions.rds")%>%
  filter(model != "flat_prior",
         model != "prior_only")

plot_child_ex3_data <- child_ex3_data%>%
  group_by(age_num,speaker,alignment)%>%
  summarise(mean = mean(correct_inf))

ggplot(child_model_predictions)+
  geom_jitter(data = plot_child_ex3_data, aes(x = age_num, y = mean), width = .01,height = .01, alpha = .2)+
  geom_line(aes(x = age, y = value, col = model), size = 1.2, alpha = 1, linetype = 1) + 
  geom_smooth(data = child_ex3_data, aes(x = age_num, y = correct_inf), col = "black", size = 0.6, method = "loess", span = 1,  se = T,  alpha = .4)+
  #geom_hline(yintercept = 0.5, lty=2)+
  labs(x="Age",y="Proportion more informative")+
  ylim(-0.05,1.05)+
  facet_grid(~speaker+ alignment)+
  coord_fixed(ratio = 1.5)+
  theme_few()+
  scale_color_manual(name=NULL,
                     breaks=c("pragmatic"),
                     labels = c("Model predictions"),
                     values= c("#859900"))
  # + theme(
  #   legend.position = c(.23, .45),
  #   legend.justification = c("right", "top"),
  #   legend.background = element_blank()
  #   )

```

```{r}
child_cor_model <- child_model_predictions %>%
  mutate(age = ifelse(age<4,"3","4"))%>%
  group_by(model,speaker,alignment, age)%>%
  summarise(Model = mean(value))
  

child_cor_plot <- child_cor_model %>%
  ungroup()%>%
  mutate(Data = rep(child_cor_data$Data,1),
         Data_ci_lower = rep(child_cor_data$Data_ci_lower,1),
         Data_ci_upper  =rep( child_cor_data$Data_ci_upper,1))


ggplot(data = child_cor_plot,aes(x = Model, y = Data, col = age)) +
  geom_abline(intercept = 0, slope = 1, lty = 2, alpha = 1, size = .5)+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin = Data_ci_lower, ymax = Data_ci_upper),width = 0,size = .5)+
  coord_fixed()+
  #facet_grid(~model)+
 stat_cor(method = "pearson", label.x = 0.01, label.y = 0.99, aes(x = Model, y = Data), inherit.aes = F)+
  xlim(0,1)+ylim(0,1)+
  xlab("Model")+
  theme_few() + 
  scale_colour_ptol()

```

